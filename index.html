<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trivial Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
        }

        h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .hidden {
            display: none !important;
        }

        /* Auth Forms */
        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
            width: 100%;
            margin-top: 10px;
        }

        button:hover {
            background: #5568d3;
        }

        button.secondary {
            background: #6c757d;
        }

        button.secondary:hover {
            background: #5a6268;
        }

        button.danger {
            background: #dc3545;
        }

        button.danger:hover {
            background: #c82333;
        }

        button.success {
            background: #28a745;
        }

        button.success:hover {
            background: #218838;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .user-info {
            color: white;
            font-weight: 500;
        }

        .score-display {
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 6px;
            color: white;
            text-align: center;
        }

        /* Question */
        .question-statement {
            font-size: 1.2em;
            margin-bottom: 20px;
            color: #333;
            line-height: 1.5;
        }

        .options {
            display: grid;
            gap: 10px;
        }

        .option-btn {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #e0e0e0;
            padding: 15px;
            text-align: left;
            transition: all 0.3s;
        }

        .option-btn:hover {
            background: #e9ecef;
            border-color: #667eea;
        }

        .option-btn.correct {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .option-btn.incorrect {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        .option-btn:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* Result */
        .result {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }

        .result.correct {
            background: #d4edda;
            color: #155724;
        }

        .result.incorrect {
            background: #f8d7da;
            color: #721c24;
        }

        /* History */
        .history-item {
            padding: 10px;
            border-left: 4px solid #667eea;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .history-item.correct {
            border-left-color: #28a745;
        }

        .history-item.incorrect {
            border-left-color: #dc3545;
        }

        /* Admin */
        .question-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .question-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .question-item h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .difficulty-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .difficulty-badge.easy {
            background: #d4edda;
            color: #155724;
        }

        .difficulty-badge.medium {
            background: #fff3cd;
            color: #856404;
        }

        .difficulty-badge.hard {
            background: #f8d7da;
            color: #721c24;
        }

        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-btn {
            background: #e9ecef;
            color: #333;
            flex: 1;
        }

        .tab-btn.active {
            background: #667eea;
            color: white;
        }

        .difficulty-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .difficulty-filter button {
            flex: 1;
            padding: 8px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Auth Screen -->
        <div id="auth-screen">
            <div class="card">
                <h1>üéÆ Trivial Game</h1>
                
                <div class="tabs">
                    <button class="tab-btn active" onclick="showLoginForm()">Login</button>
                    <button class="tab-btn" onclick="showRegisterForm()">Registro</button>
                </div>

                <!-- Login Form -->
                <form id="login-form">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="login-email" required placeholder="tu@email.com">
                    </div>
                    <div class="form-group">
                        <label>Contrase√±a</label>
                        <input type="password" id="login-password" required placeholder="******">
                    </div>
                    <button type="submit">Iniciar Sesi√≥n</button>
                </form>

                <!-- Register Form -->
                <form id="register-form" class="hidden">
                    <div class="form-group">
                        <label>Nombre de Usuario</label>
                        <input type="text" id="register-username" required placeholder="Tu nombre">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="register-email" required placeholder="tu@email.com">
                    </div>
                    <div class="form-group">
                        <label>Contrase√±a</label>
                        <input type="password" id="register-password" required placeholder="M√≠nimo 6 caracteres">
                    </div>
                    <button type="submit">Registrarse</button>
                </form>

                <div id="auth-message" class="alert hidden"></div>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="hidden">
            <div class="header">
                <div class="user-info">
                    <span id="user-name">Usuario</span>
                    <span id="user-role"></span>
                </div>
                <div class="score-display">
                    <div>Puntuaci√≥n: <span id="score-percentage">0</span>%</div>
                    <div><span id="score-correct">0</span>/<span id="score-total">0</span></div>
                </div>
                <button class="secondary" onclick="logout()">Salir</button>
            </div>

            <div class="tabs">
                <button class="tab-btn active" onclick="showGameTab()">Jugar</button>
                <button class="tab-btn" onclick="showHistoryTab()">Hist√≥rico</button>
                <button id="admin-tab-btn" class="tab-btn hidden" onclick="showAdminTab()">Admin</button>
            </div>

            <!-- Game Tab -->
            <div id="game-tab">
                <div class="card">
                    <h2>Trivial</h2>
                    
                    <div class="difficulty-filter">
                        <button onclick="loadQuestion()">Todas</button>
                        <button onclick="loadQuestion('easy')">F√°cil</button>
                        <button onclick="loadQuestion('medium')">Media</button>
                        <button onclick="loadQuestion('hard')">Dif√≠cil</button>
                    </div>

                    <div id="question-container">
                        <p style="text-align: center; color: #999;">Cargando pregunta...</p>
                    </div>

                    <div id="result-container" class="hidden"></div>

                    <button onclick="loadQuestion()" id="next-question-btn" class="hidden">Siguiente Pregunta</button>
                    <button class="danger" onclick="resetScore()">Reiniciar Puntuaci√≥n</button>
                </div>
            </div>

            <!-- History Tab -->
            <div id="history-tab" class="hidden">
                <div class="card">
                    <h2>Hist√≥rico de Respuestas</h2>
                    <div id="history-container">
                        <p style="text-align: center; color: #999;">Cargando hist√≥rico...</p>
                    </div>
                </div>
            </div>

            <!-- Admin Tab -->
            <div id="admin-tab" class="hidden">
                <div class="card">
                    <h2>Gesti√≥n de Preguntas</h2>
                    
                    <button class="success" onclick="showCreateQuestionForm()">+ Nueva Pregunta</button>
                    
                    <div id="create-question-form" class="hidden" style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 6px;">
                        <h3>Nueva Pregunta</h3>
                        <div class="form-group">
                            <label>Enunciado</label>
                            <input type="text" id="new-question-statement" placeholder="¬øCu√°l es...?">
                        </div>
                        <div class="form-group">
                            <label>Opci√≥n 0</label>
                            <input type="text" id="new-option-0" placeholder="Primera opci√≥n">
                        </div>
                        <div class="form-group">
                            <label>Opci√≥n 1</label>
                            <input type="text" id="new-option-1" placeholder="Segunda opci√≥n">
                        </div>
                        <div class="form-group">
                            <label>Opci√≥n 2</label>
                            <input type="text" id="new-option-2" placeholder="Tercera opci√≥n">
                        </div>
                        <div class="form-group">
                            <label>Opci√≥n 3</label>
                            <input type="text" id="new-option-3" placeholder="Cuarta opci√≥n">
                        </div>
                        <div class="form-group">
                            <label>Respuesta Correcta (0-3)</label>
                            <input type="number" id="new-answer-index" min="0" max="3" value="0">
                        </div>
                        <div class="form-group">
                            <label>Dificultad</label>
                            <select id="new-difficulty" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px;">
                                <option value="easy">F√°cil</option>
                                <option value="medium">Media</option>
                                <option value="hard">Dif√≠cil</option>
                            </select>
                        </div>
                        <button onclick="createQuestion()">Crear Pregunta</button>
                        <button class="secondary" onclick="hideCreateQuestionForm()">Cancelar</button>
                    </div>

                    <div id="questions-list" class="question-list" style="margin-top: 20px;">
                        <p style="text-align: center; color: #999;">Cargando preguntas...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000';
        let token = null;
        let currentUser = null;
        let currentQuestion = null;
        let currentDifficulty = null;

        // Auth Functions
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            try {
                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    token = data.access_token;
                    currentUser = data.user;
                    localStorage.setItem('token', token);
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    showGameScreen();
                } else {
                    showAuthMessage(data.message || 'Error al iniciar sesi√≥n', 'error');
                }
            } catch (error) {
                showAuthMessage('Error de conexi√≥n', 'error');
            }
        });

        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('register-username').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;

            try {
                const response = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    token = data.access_token;
                    currentUser = data.user;
                    localStorage.setItem('token', token);
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    showGameScreen();
                } else {
                    showAuthMessage(data.message || 'Error al registrarse', 'error');
                }
            } catch (error) {
                showAuthMessage('Error de conexi√≥n', 'error');
            }
        });

        function showLoginForm() {
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('register-form').classList.add('hidden');
            document.querySelectorAll('.tab-btn')[0].classList.add('active');
            document.querySelectorAll('.tab-btn')[1].classList.remove('active');
        }

        function showRegisterForm() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.remove('hidden');
            document.querySelectorAll('.tab-btn')[0].classList.remove('active');
            document.querySelectorAll('.tab-btn')[1].classList.add('active');
        }

        function showAuthMessage(message, type) {
            const messageEl = document.getElementById('auth-message');
            messageEl.textContent = message;
            messageEl.className = `alert ${type}`;
            messageEl.classList.remove('hidden');
        }

        function logout() {
            token = null;
            currentUser = null;
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('game-screen').classList.add('hidden');
        }

        function showGameScreen() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('user-name').textContent = currentUser.username;
            document.getElementById('user-role').textContent = currentUser.role === 'admin' ? 'üëë Admin' : '';
            
            if (currentUser.role === 'admin') {
                document.getElementById('admin-tab-btn').classList.remove('hidden');
            }

            loadScore();
            loadQuestion();
        }

        // Game Functions
        async function loadQuestion(difficulty = null) {
            currentDifficulty = difficulty;
            const url = difficulty ? `${API_URL}/trivial/question?difficulty=${difficulty}` : `${API_URL}/trivial/question`;
            
            try {
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (response.ok) {
                    currentQuestion = data;
                    displayQuestion(data);
                    document.getElementById('result-container').classList.add('hidden');
                    document.getElementById('next-question-btn').classList.add('hidden');
                } else {
                    alert('Error al cargar pregunta: ' + data.message);
                }
            } catch (error) {
                alert('Error de conexi√≥n');
            }
        }

        function displayQuestion(question) {
            const html = `
                <div class="question-statement">${question.statement}</div>
                <div class="options">
                    ${question.options.map(opt => `
                        <button class="option-btn" onclick="submitAnswer(${opt.index})">
                            ${opt.text}
                        </button>
                    `).join('')}
                </div>
            `;
            document.getElementById('question-container').innerHTML = html;
        }

        async function submitAnswer(selectedOption) {
            try {
                const response = await fetch(`${API_URL}/trivial/answer`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        questionId: currentQuestion._id,
                        selectedOption: selectedOption
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    displayResult(data, selectedOption);
                    loadScore();
                } else {
                    alert('Error al enviar respuesta: ' + data.message);
                }
            } catch (error) {
                alert('Error de conexi√≥n');
            }
        }

        function displayResult(result, selectedOption) {
            const resultHtml = `
                <div class="result ${result.correct ? 'correct' : 'incorrect'}">
                    ${result.correct ? '‚úÖ ¬°Correcto!' : '‚ùå Incorrecto'}
                    ${!result.correct ? ` - La respuesta correcta era: ${currentQuestion.options[result.correctOption].text}` : ''}
                </div>
            `;
            document.getElementById('result-container').innerHTML = resultHtml;
            document.getElementById('result-container').classList.remove('hidden');
            document.getElementById('next-question-btn').classList.remove('hidden');

            // Marcar opciones
            const optionBtns = document.querySelectorAll('.option-btn');
            optionBtns.forEach((btn, index) => {
                btn.disabled = true;
                if (index === result.correctOption) {
                    btn.classList.add('correct');
                }
                if (index === selectedOption && !result.correct) {
                    btn.classList.add('incorrect');
                }
            });
        }

        async function loadScore() {
            try {
                const response = await fetch(`${API_URL}/trivial/score`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (response.ok) {
                    document.getElementById('score-percentage').textContent = data.percentage;
                    document.getElementById('score-correct').textContent = data.correctAnswers;
                    document.getElementById('score-total').textContent = data.totalAnswered;
                }
            } catch (error) {
                console.error('Error al cargar puntuaci√≥n');
            }
        }

        async function resetScore() {
            if (!confirm('¬øSeguro que quieres reiniciar tu puntuaci√≥n?')) return;

            try {
                const response = await fetch(`${API_URL}/trivial/reset`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    loadScore();
                    alert('Puntuaci√≥n reiniciada');
                }
            } catch (error) {
                alert('Error al reiniciar puntuaci√≥n');
            }
        }

        async function loadHistory() {
            try {
                const response = await fetch(`${API_URL}/trivial/history`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (response.ok) {
                    if (data.history.length === 0) {
                        document.getElementById('history-container').innerHTML = '<p style="text-align: center; color: #999;">No hay respuestas en el hist√≥rico</p>';
                        return;
                    }

                    const html = data.history.map(item => `
                        <div class="history-item ${item.correct ? 'correct' : 'incorrect'}">
                            ${item.correct ? '‚úÖ' : '‚ùå'} 
                            ${new Date(item.timestamp).toLocaleString('es-ES')}
                        </div>
                    `).join('');
                    document.getElementById('history-container').innerHTML = html;
                }
            } catch (error) {
                alert('Error al cargar hist√≥rico');
            }
        }

        // Admin Functions
        async function loadQuestions() {
            try {
                const response = await fetch(`${API_URL}/questions`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (response.ok) {
                    const html = data.map(q => `
                        <div class="question-item">
                            <h4>
                                ${q.statement}
                                <span class="difficulty-badge ${q.difficulty}">${q.difficulty}</span>
                            </h4>
                            <ul>
                                ${q.options.map((opt, idx) => `
                                    <li ${idx === q.answerIndex ? 'style="color: green; font-weight: bold;"' : ''}>
                                        ${opt.text} ${idx === q.answerIndex ? '‚úì' : ''}
                                    </li>
                                `).join('')}
                            </ul>
                            <button class="danger" onclick="deleteQuestion('${q._id}')" style="margin-top: 10px; width: auto; padding: 8px 16px; font-size: 14px;">
                                Eliminar
                            </button>
                        </div>
                    `).join('');
                    document.getElementById('questions-list').innerHTML = html;
                }
            } catch (error) {
                alert('Error al cargar preguntas');
            }
        }

        function showCreateQuestionForm() {
            document.getElementById('create-question-form').classList.remove('hidden');
        }

        function hideCreateQuestionForm() {
            document.getElementById('create-question-form').classList.add('hidden');
        }

        async function createQuestion() {
            const statement = document.getElementById('new-question-statement').value;
            const options = [
                { index: 0, text: document.getElementById('new-option-0').value },
                { index: 1, text: document.getElementById('new-option-1').value },
                { index: 2, text: document.getElementById('new-option-2').value },
                { index: 3, text: document.getElementById('new-option-3').value }
            ];
            const answerIndex = parseInt(document.getElementById('new-answer-index').value);
            const difficulty = document.getElementById('new-difficulty').value;

            try {
                const response = await fetch(`${API_URL}/questions`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ statement, options, answerIndex, difficulty })
                });

                if (response.ok) {
                    alert('Pregunta creada exitosamente');
                    hideCreateQuestionForm();
                    loadQuestions();
                    // Limpiar formulario
                    document.getElementById('new-question-statement').value = '';
                    document.getElementById('new-option-0').value = '';
                    document.getElementById('new-option-1').value = '';
                    document.getElementById('new-option-2').value = '';
                    document.getElementById('new-option-3').value = '';
                    document.getElementById('new-answer-index').value = '0';
                } else {
                    const data = await response.json();
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                alert('Error de conexi√≥n');
            }
        }

        async function deleteQuestion(id) {
            if (!confirm('¬øSeguro que quieres eliminar esta pregunta?')) return;

            try {
                const response = await fetch(`${API_URL}/questions/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    alert('Pregunta eliminada');
                    loadQuestions();
                } else {
                    alert('Error al eliminar pregunta');
                }
            } catch (error) {
                alert('Error de conexi√≥n');
            }
        }

        // Tab Navigation
        function showGameTab() {
            document.getElementById('game-tab').classList.remove('hidden');
            document.getElementById('history-tab').classList.add('hidden');
            document.getElementById('admin-tab').classList.add('hidden');
            document.querySelectorAll('.tab-btn')[0].classList.add('active');
            document.querySelectorAll('.tab-btn')[1].classList.remove('active');
            if (currentUser.role === 'admin') {
                document.querySelectorAll('.tab-btn')[2].classList.remove('active');
            }
            loadQuestion(currentDifficulty);
        }

        function showHistoryTab() {
            document.getElementById('game-tab').classList.add('hidden');
            document.getElementById('history-tab').classList.remove('hidden');
            document.getElementById('admin-tab').classList.add('hidden');
            document.querySelectorAll('.tab-btn')[0].classList.remove('active');
            document.querySelectorAll('.tab-btn')[1].classList.add('active');
            if (currentUser.role === 'admin') {
                document.querySelectorAll('.tab-btn')[2].classList.remove('active');
            }
            loadHistory();
        }

        function showAdminTab() {
            document.getElementById('game-tab').classList.add('hidden');
            document.getElementById('history-tab').classList.add('hidden');
            document.getElementById('admin-tab').classList.remove('hidden');
            document.querySelectorAll('.tab-btn')[0].classList.remove('active');
            document.querySelectorAll('.tab-btn')[1].classList.remove('active');
            document.querySelectorAll('.tab-btn')[2].classList.add('active');
            loadQuestions();
        }

        // Check if user is already logged in
        window.onload = () => {
            const savedToken = localStorage.getItem('token');
            const savedUser = localStorage.getItem('user');

            if (savedToken && savedUser) {
                token = savedToken;
                currentUser = JSON.parse(savedUser);
                showGameScreen();
            }
        };
    </script>
</body>
</html>
